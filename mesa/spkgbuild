# description	: OpenGL compatible 3D graphics library
# depends	: python3-mako llvm elfutils bison flex libxext libxdamage libxshmfence libxxf86vm libxrandr libdrm libglvnd libva

name=mesa
version=22.3.5
release=1
source="https://mesa.freedesktop.org/archive/$name-$version.tar.xz
	0001-anv-force-MEDIA_INTERFACE_DESCRIPTOR_LOAD-reemit-aft.patch
	0002-iris-Retry-DRM_IOCTL_I915_GEM_EXECBUFFER2-on-ENOMEM.patch
	0003-Revert-iris-Avoid-abort-if-kernel-can-t-allocate-mem.patch"
build() {
	scratch issintalled xf86-video-amdgpu && \
	OPTS="-Dgallium-va=enabled -Dgallium-drivers=swrast,radeonsi" || \
	OPTS="-Dgallium-va=disabled -Dgallium-drivers=swrast,crocus"


	patch -Np1 -d $name-$version -i $SRC/0001-anv-force-MEDIA_INTERFACE_DESCRIPTOR_LOAD-reemit-aft.patch
	patch -Np1 -d $name-$version -i $SRC/0002-iris-Retry-DRM_IOCTL_I915_GEM_EXECBUFFER2-on-ENOMEM.patch
	patch -Np1 -d $name-$version -i $SRC/0003-Revert-iris-Avoid-abort-if-kernel-can-t-allocate-mem.patch

	venom-meson $name-$version build \
		-Db_lto=false \
		-Ddri3=enabled \
		-Degl=enabled \
		-Dllvm=enabled \
		-Dshared-llvm=enabled \
		-Dgbm=enabled \
		-Dgles1=disabled \
		-Dgles2=enabled \
		-Dglx=dri \
                -Dosmesa=false \
                -Dgallium-va=disabled \
                -Dgallium-xa=disabled \
                -Dgallium-omx=disabled \
                -Dgallium-vdpau=disabled  \
                -Dgallium-opencl=disabled  \
                -Dgallium-nine=false \
		-Dgallium-drivers=swrast,crocus \
		-Dplatforms=x11 \
		-Dshared-glapi=enabled \
		-Dvulkan-drivers= \
		-Dglvnd=true \
		-Dvideo-codecs=vc1dec,h264dec,h264enc,h265dec,h265enc \
		-Dvalgrind=disabled $OPTS
	meson compile -C build
	DESTDIR=$PKG meson install -C build

	# indirect rendering symlink
	ln -s libGLX_mesa.so.0 $PKG/usr/lib/libGLX_indirect.so.0
}
